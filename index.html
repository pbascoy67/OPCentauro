<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Datos Actuales Open Key Residentes Barrio El Centauro</title>

  <!-- Fuente de Google para un mejor look & feel -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- Librería para leer Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* ================== RESET BÁSICO ================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ================== ESTILOS GENERALES ================== */
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #79F1A4 0%, #0E5CAD 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
      color: #333;
      transition: background-color 0.3s ease, color 0.3s ease;
      position: relative; /* Permite posicionar elementos fijos dentro */
    }

    /* Clases para cambiar fondo según tipo de usuario */
    .bg-leader {
      background-color: #b3e5fc !important; /* Celeste claro */
      background-image: none !important;
    }
    .bg-dependent {
      background-color: #c8e6c9 !important; /* Verde claro */
      background-image: none !important;
    }

    /* ================== MODO OSCURO ================== */
    .dark-mode {
      background-color: #121212 !important; /* Fondo oscuro */
      background-image: none !important;
      color: #f1f1f1;
    }

    /* En modo oscuro, ajustamos estilos de contenedores, textos, bordes */
    .dark-mode .container {
      background-color: #1f1f1f;
      color: #fff;
    }
    .dark-mode input[type="text"] {
      background-color: #2c2c2c;
      color: #fff;
      border: 1px solid #444;
    }
    .dark-mode button {
      background-color: #444;
      color: #fff;
    }
    .dark-mode button:hover {
      background-color: #666;
    }
    .dark-mode .output {
      background-color: #2c2c2c;
      border: 1px solid #444;
    }
    .dark-mode .dependent-box {
      background-color: #2c2c2c;
      border-color: #444;
    }
    .dark-mode .leader-box {
      background-color: #2c2c2c;
      border-color: #444;
    }

    /* Si coincide dark-mode con leader/dependent, prioriza el modo oscuro */
    .dark-mode.bg-leader,
    .dark-mode.bg-dependent {
      background-color: #121212 !important;
    }

    /* ================== ENCABEZADO CON LOGO ================== */
    .header {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }
    .header img {
      width: 156px; /* 30% más grande que 120px */
      height: auto;
      margin-bottom: 10px;
    }
    .header h1 {
      color: #fff;
      text-align: center;
      font-size: 2rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
    }

    /* ================== CONTENEDOR PRINCIPAL ================== */
    .container {
      background-color: #fff;
      max-width: 700px;
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 20px;
      margin-bottom: 20px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* ================== SECCIONES ================== */
    .section {
      margin-bottom: 1.5rem;
    }
    .section label {
      font-weight: 700;
      display: inline-block;
      margin-bottom: 0.5rem;
    }

    /* ================== INPUTS ================== */
    input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      outline: none;
      font-size: 1rem;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* ================== BOTONES ================== */
    .btn-row {
      margin-top: 10px;
    }
    button {
      padding: 10px 20px;
      background-color: #0E5CAD;
      border: none;
      border-radius: 4px;
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #09406e;
    }

    /* ================== BOTÓN MODO OSCURO (parte inferior derecha) ================== */
    #toggleDarkMode {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 1.2rem;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ================== ÁREA DE RESPUESTA ================== */
    .output {
      margin-top: 1rem;
      background-color: #f9f9f9;
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 15px;
      min-height: 80px;
      line-height: 1.6;
      font-size: 0.95rem;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* ================== TEXTO PARPADEANTE ================== */
    .blink {
      color: #ff0000;
      font-weight: 700;
      animation: blink 1s infinite;
      margin-bottom: 10px;
      display: inline-block;
    }
    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    /* ================== RECUADROS PARA DATOS ================== */
    .dependent-box {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .leader-box {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background-color: #fafafa;
    }

    /* ================== RESPONSIVE ================== */
    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }
      button {
        width: 100%;
      }
      #toggleDarkMode {
        width: 40px;
        height: 40px;
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Encabezado con Logo y Título -->
  <div class="header">
    <!-- Ajusta la ruta de la imagen según tu repositorio -->
    <img src="./ElCentauro.jpg" alt="Logo de El Centauro">
    <h1>Datos Actuales Open Key Residentes Barrio El Centauro</h1>
  </div>

  <div class="container">
    <!-- Sección de consulta por número de documento -->
    <div class="section">
      <label for="consulta">Coloca un número de documento:</label>
      <input type="text" id="consulta" placeholder="Coloca un número de documento">
      <div class="btn-row">
        <button id="btnConsultar">Consultar</button>
      </div>
    </div>

    <!-- Área donde se muestran las respuestas -->
    <div class="output" id="respuesta"></div>
  </div>

  <!-- Botón fijo para Modo Oscuro en la parte inferior derecha -->
  <button id="toggleDarkMode" title="Modo oscuro">🌙</button>

  <script>
    /*
      ---------------------------------------------------------------------------------------
      Columnas en el Excel (en este orden):
      A: Documento
      B: Nombre y apellido
      C: Email
      D: Grupoprimario
      E: App
      F: Resp

      REGLAS DE RESPUESTA (resumidas):
      1. Solo responder si hay un número en la consulta. De lo contrario:
         "Solo estoy entrenado para contestar si colocas un número de documento."
      2. Buscar en la base el número de Documento.
         - Si no está: "El documento no existe en la base de datos de El Centauro."
      3. Si "Resp" en blanco => Dependiente
         - Mostrar: Documento, Nombre y Apellido, Email (o "No tienes email registrado."), Lote Nro. (2 dígitos de Grupoprimario)
         - Mostrar líder de grupo (en un recuadro) => mismo "Grupoprimario", "Resp" = "SI"
         - Si "App"="No", agregar "Nunca ha entrado aún a la app de Open Key."
         - Fondo Verde claro
      4. Si "Resp"="SI" => Líder
         - Fondo Celeste claro
         - Muestra "Sos Líder de Grupo" (parpadeante)
         - Muestra sus datos
         - Muestra dependientes (mismo "Grupoprimario", Resp en blanco) en recuadros (cada uno con sus datos)
         - Agrega contador de dependientes
      ---------------------------------------------------------------------------------------
    */

    let datosExcel = []; // Se almacenan los datos del Excel
    const excelUrl = './data.xlsx'; // Ajusta a la ruta real en tu repositorio

    // Al cargar la página, leemos el Excel en segundo plano
    window.addEventListener('DOMContentLoaded', () => {
      cargarExcelFijo();
    });

    function cargarExcelFijo() {
      fetch(excelUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`No se pudo acceder al archivo Excel. Código: ${response.status}`);
          }
          return response.arrayBuffer();
        })
        .then(data => {
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];

          // Convertimos la hoja a un array bidimensional
          datosExcel = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          console.log("Archivo Excel cargado exitosamente.");
        })
        .catch(error => {
          console.error("Error al cargar el Excel fijo:", error);
        });
    }

    // Botón de consulta
    document.getElementById('btnConsultar').addEventListener('click', function() {
      const consulta = document.getElementById('consulta').value.trim();
      const respuesta = document.getElementById('respuesta');

      // Limpiar la respuesta previa
      respuesta.innerHTML = "";

      // Quitamos clases anteriores de fondo que indiquen líder/dependiente
      document.body.classList.remove('bg-leader', 'bg-dependent');

      // Verificar si hay datos cargados
      if (!datosExcel || datosExcel.length === 0) {
        respuesta.innerText = "No hay datos cargados. Revisa si el archivo Excel está correctamente disponible en el repositorio.";
        return;
      }

      // Extraer el número de documento de la consulta (uno o más dígitos)
      const regexDoc = /(\d+)/;
      const match = consulta.match(regexDoc);
      if (!match) {
        respuesta.innerText = "Solo estoy entrenado para contestar si colocas un número de documento.";
        return;
      }
      const numeroDocumento = match[0];

      // Identificar columnas en la primera fila
      const headers = datosExcel[0].map(h => (h || '').toString().trim().toLowerCase());
      const colDoc   = headers.indexOf("documento");
      const colNom   = headers.indexOf("nombre y apellido");
      const colEmail = headers.indexOf("email");
      const colGrupo = headers.indexOf("grupoprimario");
      const colApp   = headers.indexOf("app");
      const colResp  = headers.indexOf("resp");

      if ([colDoc, colNom, colEmail, colGrupo, colApp, colResp].includes(-1)) {
        respuesta.innerText = "El archivo Excel no contiene las columnas requeridas (Documento, Nombre y apellido, Email, Grupoprimario, App, Resp).";
        return;
      }

      // Buscar la fila con el documento
      let filaEncontrada = null;
      for (let i = 1; i < datosExcel.length; i++) {
        const fila = datosExcel[i];
        if (!fila[colDoc]) continue;
        const valorDoc = fila[colDoc].toString().trim();
        if (valorDoc === numeroDocumento) {
          filaEncontrada = fila;
          break;
        }
      }

      // Si no se encontró, avisar
      if (!filaEncontrada) {
        respuesta.innerText = "El documento no existe en la base de datos de El Centauro.";
        return;
      }

      // Extraer valores de la fila
      const valDoc    = filaEncontrada[colDoc]   ? filaEncontrada[colDoc].toString().trim()   : "";
      const valNom    = filaEncontrada[colNom]   ? filaEncontrada[colNom].toString().trim()   : "";
      const valEmail  = filaEncontrada[colEmail] ? filaEncontrada[colEmail].toString().trim() : "";
      const valGrupo  = filaEncontrada[colGrupo] ? filaEncontrada[colGrupo].toString().trim() : "";
      const valApp    = filaEncontrada[colApp]   ? filaEncontrada[colApp].toString().trim()   : "";
      const valResp   = filaEncontrada[colResp]  ? filaEncontrada[colResp].toString().trim().toUpperCase() : "";

      // Lote Nro = 2 primeros dígitos de Grupoprimario
      const loteNro = valGrupo.length >= 2 ? valGrupo.substring(0,2) : valGrupo;

      // Funciones para formatear cada línea con <strong>
      function linea(label, valor) {
        return `<strong>${label}:</strong> ${valor}<br>`;
      }
      function lineaExtra(texto) {
        return `${texto}<br>`;
      }

      // Construimos la respuesta final
      let respuestaHTML = "";

      // Muestra datos básicos (Documento, Nombre, Email, Lote)
      function datosBasicos(doc, nom, mail, lote) {
        let txt = "";
        txt += linea("Documento", doc);
        txt += linea("Nombre y apellido", nom);
        if (mail === "") {
          txt += lineaExtra("No tienes email registrado.");
        } else {
          txt += linea("Email", mail);
        }
        txt += linea("Lote Nro.", lote);
        txt += "<br>";
        return txt;
      }

      // -- CASO 1: Resp en blanco => Dependiente
      if (valResp === "") {
        // Fondo verde claro
        document.body.classList.add('bg-dependent');

        respuestaHTML += datosBasicos(valDoc, valNom, valEmail, loteNro);

        // Buscar Líder de grupo => mismo "Grupoprimario", "Resp" = "SI"
        let liderNombre = "";
        let liderEncontrado = null;
        for (let i = 1; i < datosExcel.length; i++) {
          const f = datosExcel[i];
          if (!f[colGrupo] || !f[colResp]) continue;
          const gp = f[colGrupo].toString().trim();
          const rp = f[colResp].toString().trim().toUpperCase();
          if (gp === valGrupo && rp === "SI") {
            liderEncontrado = f;
            liderNombre = liderEncontrado[colNom] ? liderEncontrado[colNom].toString().trim() : "";
            break;
          }
        }
        if (liderNombre) {
          // Recuadro para mostrar al líder
          respuestaHTML += `
            <div class="leader-box">
              <strong>Líder de grupo:</strong> ${liderNombre}
            </div>
          `;
        } else {
          respuestaHTML += lineaExtra("No se encontró un líder de grupo para tu lote.");
        }
        if (valApp.toLowerCase() === "no") {
          respuestaHTML += lineaExtra("Nunca ha entrado aún a la app de Open Key.");
        }

      // -- CASO 2: Resp = "SI" => Líder
      } else if (valResp === "SI") {
        // Fondo celeste claro
        document.body.classList.add('bg-leader');

        // Muestra cartel parpadeante “Sos Líder de Grupo”
        respuestaHTML += `<div class="blink">Sos Líder de Grupo</div><br>`;

        // Datos del líder
        respuestaHTML += datosBasicos(valDoc, valNom, valEmail, loteNro);

        // Mensaje especial para líderes
        respuestaHTML += lineaExtra(
          "Vos como Líder de grupo podes entrar a la aplicación de Open Key en la sección Censo - Mi Grupo Familiar " +
          "y buscando por número de documento de tus dependientes podrás modificar los siguientes datos:"
        );
        respuestaHTML += lineaExtra("• Nombre y apellido (si está mal cargado).");
        respuestaHTML += lineaExtra("• Email (si no es correcto; este será el usuario para registrarse en la aplicación Open Key).");
        respuestaHTML += lineaExtra("• Teléfono (si está incorrecto o en blanco).");
        respuestaHTML += lineaExtra("• Relación de parentesco (si está incorrecta o en blanco).");
        respuestaHTML += lineaExtra(
          "Nota: El email es el usuario para entrar a Open Key, " +
          "por lo tanto, asegúrate de que todos los dependientes tengan un email único."
        );
        respuestaHTML += "<br>";

        // Listar dependientes => misma "Grupoprimario", "Resp" en blanco
        let dependientesHTML = "";
        let contadorDependientes = 0;
        for (let i = 1; i < datosExcel.length; i++) {
          const f = datosExcel[i];
          const gp = f[colGrupo] ? f[colGrupo].toString().trim() : "";
          const rp = f[colResp]  ? f[colResp].toString().trim().toUpperCase() : "";
          if (gp === valGrupo && rp === "") {
            contadorDependientes++;
            // Extraer info dependiente
            const dDoc   = f[colDoc]   ? f[colDoc].toString().trim() : "";
            const dNom   = f[colNom]   ? f[colNom].toString().trim() : "";
            const dEmail = f[colEmail] ? f[colEmail].toString().trim() : "";
            const dApp   = f[colApp]   ? f[colApp].toString().trim() : "";
            const dLote  = gp.length >= 2 ? gp.substring(0,2) : gp;

            // Recuadro para cada dependiente
            let dependienteBox = `<div class="dependent-box">`;
            dependienteBox += linea("Documento", dDoc);
            dependienteBox += linea("Nombre y apellido", dNom);
            if (dEmail === "") {
              dependienteBox += lineaExtra("No tienes email registrado.");
            } else {
              dependienteBox += linea("Email", dEmail);
            }
            dependienteBox += linea("Lote Nro.", dLote);

            if (dApp.toLowerCase() === "no") {
              dependienteBox += lineaExtra("Nunca ha entrado aún a la app de Open Key.");
            }
            dependienteBox += "</div>";

            dependientesHTML += dependienteBox;
          }
        }

        if (contadorDependientes > 0) {
          respuestaHTML += lineaExtra(`Cantidad de dependientes: ${contadorDependientes}`);
          respuestaHTML += dependientesHTML;
        } else {
          respuestaHTML += lineaExtra("No tienes dependientes registrados en tu grupo.");
        }
      }

      // Mostrar la respuesta final en formato HTML
      respuesta.innerHTML = respuestaHTML;
    });

    // Botón para modo oscuro (fijo abajo a la derecha)
    document.getElementById('toggleDarkMode').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
    });
  </script>
</body>
</html>
